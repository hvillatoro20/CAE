<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Compartida</title>
    <style>
        :root {
            --color-pendiente: #ff6b6b;
            --color-ejecucion: #feca57;
            --color-completado: #1dd1a1;
            --color-fondo: #f5f6fa;
            --color-texto: #2f3640;
            --color-borde: #dcdde1;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--color-fondo);
            color: var(--color-texto);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        h1 {
            color: var(--color-texto);
            margin-bottom: 10px;
        }

        .date-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .date-selector input {
            padding: 8px;
            border: 1px solid var(--color-borde);
            border-radius: 5px;
        }

        .employee-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .employee-info input {
            padding: 8px;
            border: 1px solid var(--color-borde);
            border-radius: 5px;
            width: 200px;
        }

        .share-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .share-link {
            flex-grow: 1;
            padding: 8px;
            border: 1px dashed var(--color-borde);
            border-radius: 5px;
            background: white;
            word-break: break-all;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: var(--color-completado);
            color: white;
        }

        .btn-success:hover {
            background-color: #10ac84;
        }

        .btn-pendiente {
            background-color: var(--color-pendiente);
            color: white;
        }

        .btn-ejecucion {
            background-color: var(--color-ejecucion);
            color: var(--color-texto);
        }

        .btn-completado {
            background-color: var(--color-completado);
            color: white;
        }

        .productivity {
            margin-bottom: 20px;
        }

        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-top: 5px;
        }

        .progress-bar {
            height: 20px;
            border-radius: 5px;
            background-color: var(--color-completado);
            width: 0%;
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .schedule {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 10px;
        }

        .time-slots {
            display: grid;
            grid-template-rows: repeat(18, 1fr);
            gap: 5px;
        }

        .time-slot {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #7f8c8d;
        }

        .tasks {
            display: grid;
            grid-template-rows: repeat(18, 1fr);
            gap: 5px;
        }

        .task {
            height: 40px;
            border-radius: 5px;
            padding: 5px 10px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .task.pendiente {
            background-color: var(--color-pendiente);
            color: white;
        }

        .task.ejecucion {
            background-color: var(--color-ejecucion);
            color: var(--color-texto);
        }

        .task.completado {
            background-color: var(--color-completado);
            color: white;
        }

        .task-content {
            flex-grow: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-project {
            font-size: 0.8em;
            background: rgba(0, 0, 0, 0.2);
            padding: 2px 5px;
            border-radius: 3px;
            margin-left: 5px;
        }

        .task-status-buttons {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }

        .status-btn {
            padding: 3px 8px;
            font-size: 0.7em;
            border-radius: 3px;
            cursor: pointer;
            border: none;
        }

        .task-form {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
            z-index: 100;
            width: 90%;
            max-width: 400px;
            display: none;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--color-borde);
            border-radius: 5px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
            display: none;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--color-ejecucion);
            color: var(--color-texto);
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 101;
        }

        .boss-view {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .boss-view h3 {
            margin-bottom: 10px;
        }

        .employee-selector {
            margin-bottom: 15px;
        }

        .employee-selector select {
            padding: 8px;
            border: 1px solid var(--color-borde);
            border-radius: 5px;
            width: 100%;
            max-width: 300px;
        }

        @media (max-width: 768px) {
            .schedule {
                grid-template-columns: 60px 1fr;
            }
            
            .time-slot {
                font-size: 10px;
            }
            
            .task {
                font-size: 12px;
            }
            
            .task-status-buttons {
                flex-direction: column;
                gap: 2px;
            }
            
            .status-btn {
                padding: 2px 5px;
                font-size: 0.6em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Agenda Compartida</h1>
            <div class="date-selector">
                <input type="date" id="datePicker">
                <button id="todayBtn" class="btn btn-primary">Hoy</button>
            </div>
        </header>

        <div class="employee-info">
            <input type="text" id="employeeName" placeholder="Ingresa tu nombre">
            <button id="saveEmployeeBtn" class="btn btn-primary">Guardar</button>
        </div>

        <div class="share-section" id="shareSection" style="display: none;">
            <h3>Compartir agenda con tu jefe:</h3>
            <input type="text" id="shareLink" class="share-link" readonly>
            <button id="copyLinkBtn" class="btn btn-primary">Copiar</button>
            <button id="shareWhatsAppBtn" class="btn btn-success">Compartir por WhatsApp</button>
        </div>

        <div class="productivity">
            <h3>Productividad: <span id="productivityPercentage">0%</span></h3>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
        </div>

        <div class="schedule">
            <div class="time-slots">
                <!-- Horas de 8:00 AM a 5:00 PM en intervalos de 30 minutos -->
                <div class="time-slot">8:00 AM</div>
                <div class="time-slot">8:30 AM</div>
                <div class="time-slot">9:00 AM</div>
                <div class="time-slot">9:30 AM</div>
                <div class="time-slot">10:00 AM</div>
                <div class="time-slot">10:30 AM</div>
                <div class="time-slot">11:00 AM</div>
                <div class="time-slot">11:30 AM</div>
                <div class="time-slot">12:00 PM</div>
                <div class="time-slot">12:30 PM</div>
                <div class="time-slot">1:00 PM</div>
                <div class="time-slot">1:30 PM</div>
                <div class="time-slot">2:00 PM</div>
                <div class="time-slot">2:30 PM</div>
                <div class="time-slot">3:00 PM</div>
                <div class="time-slot">3:30 PM</div>
                <div class="time-slot">4:00 PM</div>
                <div class="time-slot">4:30 PM</div>
                <div class="time-slot">5:00 PM</div>
            </div>
            <div class="tasks" id="tasksContainer">
                <!-- Las tareas se generarán dinámicamente aquí -->
            </div>
        </div>

        <button id="addTaskBtn" class="btn btn-primary" style="margin-top: 20px;">+ Agregar Tarea</button>
        <button id="printBtn" class="btn btn-success" style="margin-top: 20px; margin-left: 10px;">Imprimir Agenda</button>

        <!-- Vista para el jefe -->
        <div class="boss-view" id="bossView" style="display: none;">
            <h3>Vista del Jefe</h3>
            <div class="employee-selector">
                <select id="employeeSelector">
                    <option value="">Selecciona un empleado</option>
                </select>
            </div>
            <div id="bossScheduleContainer"></div>
        </div>
    </div>

    <!-- Formulario flotante para agregar/editar tareas -->
    <div class="overlay" id="overlay"></div>
    <div class="task-form" id="taskForm">
        <h3 id="formTitle">Agregar Nueva Tarea</h3>
        <div class="form-group">
            <label for="taskTime">Hora:</label>
            <select id="taskTime">
                <option value="8:00 AM">8:00 AM</option>
                <option value="8:30 AM">8:30 AM</option>
                <option value="9:00 AM">9:00 AM</option>
                <option value="9:30 AM">9:30 AM</option>
                <option value="10:00 AM">10:00 AM</option>
                <option value="10:30 AM">10:30 AM</option>
                <option value="11:00 AM">11:00 AM</option>
                <option value="11:30 AM">11:30 AM</option>
                <option value="12:00 PM">12:00 PM</option>
                <option value="12:30 PM">12:30 PM</option>
                <option value="1:00 PM">1:00 PM</option>
                <option value="1:30 PM">1:30 PM</option>
                <option value="2:00 PM">2:00 PM</option>
                <option value="2:30 PM">2:30 PM</option>
                <option value="3:00 PM">3:00 PM</option>
                <option value="3:30 PM">3:30 PM</option>
                <option value="4:00 PM">4:00 PM</option>
                <option value="4:30 PM">4:30 PM</option>
                <option value="5:00 PM">5:00 PM</option>
            </select>
        </div>
        <div class="form-group">
            <label for="taskName">Nombre de la tarea:</label>
            <input type="text" id="taskName" placeholder="Ej: Revisar informe">
        </div>
        <div class="form-group">
            <label for="taskProject">Proyecto:</label>
            <input type="text" id="taskProject" placeholder="Ej: Proyecto X" list="projectsList">
            <datalist id="projectsList">
                <!-- Opciones de proyectos se llenarán dinámicamente -->
            </datalist>
        </div>
        <div class="form-actions">
            <button id="cancelTaskBtn" class="btn">Cancelar</button>
            <button id="saveTaskBtn" class="btn btn-primary">Guardar</button>
        </div>
    </div>

    <!-- Notificación -->
    <div class="notification" id="notification"></div>

    <script>
        // Variables globales
        let currentDate = new Date();
        let employeeName = '';
        let tasks = [];
        let projects = [];
        let employees = [];
        let isReadOnly = false;
        let isBossView = false;
        let editingTaskId = null;

        // Elementos del DOM
        const datePicker = document.getElementById('datePicker');
        const todayBtn = document.getElementById('todayBtn');
        const employeeNameInput = document.getElementById('employeeName');
        const saveEmployeeBtn = document.getElementById('saveEmployeeBtn');
        const shareSection = document.getElementById('shareSection');
        const shareLink = document.getElementById('shareLink');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const shareWhatsAppBtn = document.getElementById('shareWhatsAppBtn');
        const productivityPercentage = document.getElementById('productivityPercentage');
        const progressBar = document.getElementById('progressBar');
        const tasksContainer = document.getElementById('tasksContainer');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const printBtn = document.getElementById('printBtn');
        const bossView = document.getElementById('bossView');
        const employeeSelector = document.getElementById('employeeSelector');
        const bossScheduleContainer = document.getElementById('bossScheduleContainer');
        const overlay = document.getElementById('overlay');
        const taskForm = document.getElementById('taskForm');
        const formTitle = document.getElementById('formTitle');
        const taskTime = document.getElementById('taskTime');
        const taskName = document.getElementById('taskName');
        const taskProject = document.getElementById('taskProject');
        const projectsList = document.getElementById('projectsList');
        const cancelTaskBtn = document.getElementById('cancelTaskBtn');
        const saveTaskBtn = document.getElementById('saveTaskBtn');
        const notification = document.getElementById('notification');

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar si estamos en modo de solo lectura (acceso del jefe)
            checkReadOnlyMode();
            
            // Verificar si es la vista del jefe
            checkBossView();
            
            // Configurar el selector de fecha
            setupDatePicker();
            
            // Cargar datos del empleado y tareas
            loadEmployeeData();
            loadTasks();
            loadProjects();
            loadEmployees();
            
            // Configurar eventos
            setupEventListeners();
            
            // Mostrar tareas para la fecha actual
            renderTasks();
            
            // Actualizar productividad
            updateProductivity();
            
            // Verificar notificaciones de tareas
            checkTaskNotifications();
            
            // Verificar cada minuto si hay notificaciones
            setInterval(checkTaskNotifications, 60000);
        });

        // Funciones principales
        function checkReadOnlyMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const employeeParam = urlParams.get('empleado');
            
            if (employeeParam) {
                isReadOnly = true;
                employeeName = decodeURIComponent(employeeParam);
                document.title = `Agenda de ${employeeName}`;
                employeeNameInput.value = employeeName;
                employeeNameInput.disabled = true;
                saveEmployeeBtn.style.display = 'none';
                addTaskBtn.style.display = 'none';
                shareSection.style.display = 'none';
            }
        }

        function checkBossView() {
            const urlParams = new URLSearchParams(window.location.search);
            const bossParam = urlParams.get('jefe');
            
            if (bossParam === 'true') {
                isBossView = true;
                document.title = 'Vista del Jefe - Agenda Compartida';
                employeeNameInput.style.display = 'none';
                saveEmployeeBtn.style.display = 'none';
                addTaskBtn.style.display = 'none';
                shareSection.style.display = 'none';
                bossView.style.display = 'block';
                loadEmployeesForBoss();
            }
        }

        function setupDatePicker() {
            datePicker.valueAsDate = currentDate;
            datePicker.max = new Date().toISOString().split('T')[0];
        }

        function loadEmployeeData() {
            const savedName = localStorage.getItem('employeeName');
            if (savedName) {
                employeeName = savedName;
                employeeNameInput.value = employeeName;
                
                if (!isReadOnly && !isBossView) {
                    shareSection.style.display = 'flex';
                    updateShareLink();
                }
            }
        }

        function loadTasks() {
            const savedTasks = localStorage.getItem(`tasks_${employeeName}`);
            if (savedTasks) {
                tasks = JSON.parse(savedTasks);
            }
        }

        function loadProjects() {
            const savedProjects = localStorage.getItem(`projects_${employeeName}`);
            if (savedProjects) {
                projects = JSON.parse(savedProjects);
                updateProjectsList();
            }
        }

        function loadEmployees() {
            const savedEmployees = localStorage.getItem('employees');
            if (savedEmployees) {
                employees = JSON.parse(savedEmployees);
            }
        }

        function loadEmployeesForBoss() {
            const savedEmployees = localStorage.getItem('employees');
            if (savedEmployees) {
                employees = JSON.parse(savedEmployees);
                updateEmployeeSelector();
            }
        }

        function updateEmployeeSelector() {
            employeeSelector.innerHTML = '<option value="">Selecciona un empleado</option>';
            employees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee;
                option.textContent = employee;
                employeeSelector.appendChild(option);
            });
        }

        function saveEmployeeData() {
            if (employeeNameInput.value.trim() === '') {
                showNotification('Por favor ingresa tu nombre');
                return;
            }
            
            employeeName = employeeNameInput.value.trim();
            localStorage.setItem('employeeName', employeeName);
            
            // Guardar empleado en la lista de empleados
            if (!employees.includes(employeeName)) {
                employees.push(employeeName);
                localStorage.setItem('employees', JSON.stringify(employees));
            }
            
            shareSection.style.display = 'flex';
            updateShareLink();
            
            showNotification('Nombre guardado correctamente');
        }

        function saveTasks() {
            localStorage.setItem(`tasks_${employeeName}`, JSON.stringify(tasks));
        }

        function saveProjects() {
            // Agregar el nuevo proyecto si no existe
            const newProject = taskProject.value.trim();
            if (newProject && !projects.includes(newProject)) {
                projects.push(newProject);
                localStorage.setItem(`projects_${employeeName}`, JSON.stringify(projects));
                updateProjectsList();
            }
        }

        function updateProjectsList() {
            projectsList.innerHTML = '';
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project;
                projectsList.appendChild(option);
            });
        }

        function updateShareLink() {
            if (!employeeName) return;
            
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('empleado', encodeURIComponent(employeeName));
            shareLink.value = currentUrl.toString();
        }

        function setupEventListeners() {
            // Selector de fecha
            datePicker.addEventListener('change', function() {
                currentDate = new Date(this.value);
                renderTasks();
            });
            
            // Botón "Hoy"
            todayBtn.addEventListener('click', function() {
                currentDate = new Date();
                datePicker.valueAsDate = currentDate;
                renderTasks();
            });
            
            // Guardar nombre de empleado
            saveEmployeeBtn.addEventListener('click', saveEmployeeData);
            
            // Copiar link
            copyLinkBtn.addEventListener('click', function() {
                shareLink.select();
                document.execCommand('copy');
                showNotification('Link copiado al portapapeles');
            });
            
            // Compartir por WhatsApp
            shareWhatsAppBtn.addEventListener('click', function() {
                const message = `Aquí está mi agenda compartida: ${shareLink.value}`;
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            });
            
            // Agregar tarea
            addTaskBtn.addEventListener('click', openTaskForm);
            
            // Imprimir agenda
            printBtn.addEventListener('click', function() {
                window.print();
            });
            
            // Selector de empleado (vista jefe)
            employeeSelector.addEventListener('change', function() {
                if (this.value) {
                    employeeName = this.value;
                    loadTasks();
                    renderBossSchedule();
                }
            });
            
            // Formulario de tarea
            cancelTaskBtn.addEventListener('click', closeTaskForm);
            saveTaskBtn.addEventListener('click', saveTask);
            
            // Permitir cerrar el formulario haciendo clic en el overlay
            overlay.addEventListener('click', closeTaskForm);
        }

        function renderTasks() {
            if (!employeeName) return;
            
            tasksContainer.innerHTML = '';
            
            // Crear 18 slots (de 8:00 AM a 5:00 PM en intervalos de 30 minutos)
            for (let i = 0; i < 18; i++) {
                const hour = Math.floor(i / 2) + 8;
                const minutes = (i % 2) * 30;
                const timeString = `${hour}:${minutes === 0 ? '00' : '30'} ${hour < 12 ? 'AM' : 'PM'}`;
                
                // Buscar tareas para esta hora
                const dateKey = formatDate(currentDate);
                const hourTasks = tasks.filter(task => 
                    task.date === dateKey && 
                    task.time === timeString
                );
                
                // Crear contenedor de tarea
                const taskSlot = document.createElement('div');
                taskSlot.className = 'task-slot';
                
                if (hourTasks.length > 0) {
                    // Mostrar tareas existentes
                    hourTasks.forEach(task => {
                        const taskElement = createTaskElement(task);
                        tasksContainer.appendChild(taskElement);
                    });
                } else {
                    // Mostrar slot vacío
                    const taskElement = document.createElement('div');
                    taskElement.className = 'task empty';
                    taskElement.dataset.time = timeString;
                    
                    if (!isReadOnly && !isBossView) {
                        taskElement.addEventListener('click', function() {
                            openTaskForm(timeString);
                        });
                    }
                    
                    tasksContainer.appendChild(taskElement);
                }
            }
        }

        function renderBossSchedule() {
            if (!employeeName) return;
            
            bossScheduleContainer.innerHTML = `
                <h4>Agenda de ${employeeName} - ${formatDate(currentDate, true)}</h4>
                <div class="schedule">
                    <div class="time-slots">
                        <div class="time-slot">8:00 AM</div>
                        <div class="time-slot">8:30 AM</div>
                        <div class="time-slot">9:00 AM</div>
                        <div class="time-slot">9:30 AM</div>
                        <div class="time-slot">10:00 AM</div>
                        <div class="time-slot">10:30 AM</div>
                        <div class="time-slot">11:00 AM</div>
                        <div class="time-slot">11:30 AM</div>
                        <div class="time-slot">12:00 PM</div>
                        <div class="time-slot">12:30 PM</div>
                        <div class="time-slot">1:00 PM</div>
                        <div class="time-slot">1:30 PM</div>
                        <div class="time-slot">2:00 PM</div>
                        <div class="time-slot">2:30 PM</div>
                        <div class="time-slot">3:00 PM</div>
                        <div class="time-slot">3:30 PM</div>
                        <div class="time-slot">4:00 PM</div>
                        <div class="time-slot">4:30 PM</div>
                        <div class="time-slot">5:00 PM</div>
                    </div>
                    <div class="tasks" id="bossTasksContainer"></div>
                </div>
            `;
            
            const bossTasksContainer = document.getElementById('bossTasksContainer');
            
            // Crear 18 slots (de 8:00 AM a 5:00 PM en intervalos de 30 minutos)
            for (let i = 0; i < 18; i++) {
                const hour = Math.floor(i / 2) + 8;
                const minutes = (i % 2) * 30;
                const timeString = `${hour}:${minutes === 0 ? '00' : '30'} ${hour < 12 ? 'AM' : 'PM'}`;
                
                // Buscar tareas para esta hora
                const dateKey = formatDate(currentDate);
                const hourTasks = tasks.filter(task => 
                    task.date === dateKey && 
                    task.time === timeString
                );
                
                if (hourTasks.length > 0) {
                    // Mostrar tareas existentes
                    hourTasks.forEach(task => {
                        const taskElement = createBossTaskElement(task);
                        bossTasksContainer.appendChild(taskElement);
                    });
                } else {
                    // Mostrar slot vacío
                    const taskElement = document.createElement('div');
                    taskElement.className = 'task empty';
                    taskElement.textContent = 'Sin tareas';
                    bossTasksContainer.appendChild(taskElement);
                }
            }
        }

        function createTaskElement(task) {
            const taskElement = document.createElement('div');
            taskElement.className = `task ${task.status}`;
            taskElement.dataset.id = task.id;
            
            const taskContent = document.createElement('div');
            taskContent.className = 'task-content';
            
            const taskNameSpan = document.createElement('span');
            taskNameSpan.textContent = task.name;
            
            const taskProjectSpan = document.createElement('span');
            taskProjectSpan.className = 'task-project';
            taskProjectSpan.textContent = task.project;
            
            taskContent.appendChild(taskNameSpan);
            taskContent.appendChild(taskProjectSpan);
            
            // Botones de estado
            const statusButtons = document.createElement('div');
            statusButtons.className = 'task-status-buttons';
            
            const pendienteBtn = document.createElement('button');
            pendienteBtn.className = 'status-btn btn-pendiente';
            pendienteBtn.textContent = 'Pendiente';
            pendienteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                updateTaskStatus(task.id, 'pendiente');
            });
            
            const ejecucionBtn = document.createElement('button');
            ejecucionBtn.className = 'status-btn btn-ejecucion';
            ejecucionBtn.textContent = 'En Ejecución';
            ejecucionBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                updateTaskStatus(task.id, 'ejecucion');
            });
            
            const completadoBtn = document.createElement('button');
            completadoBtn.className = 'status-btn btn-completado';
            completadoBtn.textContent = 'Completado';
            completadoBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                updateTaskStatus(task.id, 'completado');
            });
            
            statusButtons.appendChild(pendienteBtn);
            statusButtons.appendChild(ejecucionBtn);
            statusButtons.appendChild(completadoBtn);
            
            taskElement.appendChild(taskContent);
            taskElement.appendChild(statusButtons);
            
            if (!isReadOnly) {
                taskElement.addEventListener('dblclick', function() {
                    editTask(task.id);
                });
            }
            
            return taskElement;
        }

        function createBossTaskElement(task) {
            const taskElement = document.createElement('div');
            taskElement.className = `task ${task.status}`;
            
            const taskContent = document.createElement('div');
            taskContent.className = 'task-content';
            
            const taskNameSpan = document.createElement('span');
            taskNameSpan.textContent = task.name;
            
            const taskProjectSpan = document.createElement('span');
            taskProjectSpan.className = 'task-project';
            taskProjectSpan.textContent = task.project;
            
            const taskStatusSpan = document.createElement('span');
            taskStatusSpan.className = 'task-status';
            taskStatusSpan.textContent = `Estado: ${getStatusText(task.status)}`;
            taskStatusSpan.style.marginLeft = '10px';
            taskStatusSpan.style.fontStyle = 'italic';
            taskStatusSpan.style.fontSize = '0.8em';
            
            taskContent.appendChild(taskNameSpan);
            taskContent.appendChild(taskProjectSpan);
            taskContent.appendChild(taskStatusSpan);
            taskElement.appendChild(taskContent);
            
            return taskElement;
        }

        function getStatusText(status) {
            switch(status) {
                case 'pendiente': return 'Pendiente';
                case 'ejecucion': return 'En Ejecución';
                case 'completado': return 'Completado';
                default: return status;
            }
        }

        function updateTaskStatus(taskId, newStatus) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            task.status = newStatus;
            saveTasks();
            renderTasks();
            updateProductivity();
        }

        function openTaskForm(prefilledTime = null) {
            if (!employeeName) {
                showNotification('Por favor ingresa tu nombre primero');
                return;
            }
            
            if (prefilledTime) {
                taskTime.value = prefilledTime;
            } else {
                // Establecer la hora actual como predeterminada
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinutes = now.getMinutes();
                
                let hour = currentHour;
                let minutes = currentMinutes >= 30 ? '30' : '00';
                let period = hour >= 12 ? 'PM' : 'AM';
                
                if (hour > 12) hour -= 12;
                if (hour === 0) hour = 12;
                
                taskTime.value = `${hour}:${minutes} ${period}`;
            }
            
            taskName.value = '';
            taskProject.value = '';
            editingTaskId = null;
            formTitle.textContent = 'Agregar Nueva Tarea';
            
            overlay.style.display = 'block';
            taskForm.style.display = 'block';
        }

        function closeTaskForm() {
            overlay.style.display = 'none';
            taskForm.style.display = 'none';
        }

        function saveTask() {
            const time = taskTime.value;
            const name = taskName.value.trim();
            const project = taskProject.value.trim();
            
            if (!name) {
                showNotification('Por favor ingresa un nombre para la tarea');
                return;
            }
            
            if (!project) {
                showNotification('Por favor ingresa un nombre de proyecto');
                return;
            }
            
            const dateKey = formatDate(currentDate);
            
            if (editingTaskId) {
                // Editar tarea existente
                const taskIndex = tasks.findIndex(task => task.id === editingTaskId);
                if (taskIndex !== -1) {
                    tasks[taskIndex] = {
                        ...tasks[taskIndex],
                        time,
                        name,
                        project
                    };
                }
            } else {
                // Crear nueva tarea
                const newTask = {
                    id: Date.now().toString(),
                    date: dateKey,
                    time,
                    name,
                    project,
                    status: 'pendiente'
                };
                
                tasks.push(newTask);
            }
            
            saveTasks();
            saveProjects();
            renderTasks();
            updateProductivity();
            closeTaskForm();
            
            showNotification(editingTaskId ? 'Tarea actualizada' : 'Tarea agregada');
        }

        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            editingTaskId = taskId;
            taskTime.value = task.time;
            taskName.value = task.name;
            taskProject.value = task.project;
            formTitle.textContent = 'Editar Tarea';
            
            overlay.style.display = 'block';
            taskForm.style.display = 'block';
        }

        function updateProductivity() {
            if (tasks.length === 0) {
                productivityPercentage.textContent = '0%';
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
                return;
            }
            
            const dateKey = formatDate(currentDate);
            const todayTasks = tasks.filter(task => task.date === dateKey);
            
            if (todayTasks.length === 0) {
                productivityPercentage.textContent = '0%';
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
                return;
            }
            
            const completedTasks = todayTasks.filter(task => task.status === 'completado').length;
            const percentage = Math.round((completedTasks / todayTasks.length) * 100);
            
            productivityPercentage.textContent = `${percentage}%`;
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${percentage}%`;
        }

        function checkTaskNotifications() {
            if (isReadOnly || isBossView) return;
            
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            tasks.forEach(task => {
                if (task.notified) return;
                
                const taskDate = new Date(task.date);
                if (taskDate.toDateString() !== now.toDateString()) return;
                
                const taskTimeParts = task.time.split(/[: ]/);
                let taskHour = parseInt(taskTimeParts[0]);
                const taskMinutes = parseInt(taskTimeParts[1]);
                const period = taskTimeParts[2];
                
                if (period === 'PM' && taskHour < 12) taskHour += 12;
                if (period === 'AM' && taskHour === 12) taskHour = 0;
                
                const taskTimeInMinutes = taskHour * 60 + taskMinutes;
                
                // Notificar 10 minutos antes
                if (taskTimeInMinutes - currentTime === 10) {
                    showNotification(`Tarea próxima: "${task.name}" a las ${task.time}`);
                    task.notified = true;
                    saveTasks();
                }
            });
        }

        function showNotification(message) {
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // Funciones auxiliares
        function formatDate(date, withWeekday = false) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            if (!withWeekday) {
                return `${year}-${month}-${day}`;
            }
            
            const weekdays = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            const weekday = weekdays[date.getDay()];
            return `${weekday}, ${day}/${month}/${year}`;
        }
    </script>
</body>
</html>